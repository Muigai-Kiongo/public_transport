{% extends "base.html" %}
{% block content %}
<div class="bg-white rounded-xl shadow p-6 max-w-3xl mx-auto">
  <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
    <span class="text-transport-blue">Book Trip</span>
    <span class="text-2xl">ðŸŽ«</span>
  </h2>

  <form method="post" id="booking-form" class="space-y-6">
    {% csrf_token %}
    <div>
      <label for="id_trip" class="block font-medium text-gray-700 mb-2">Trip</label>
      {{ form.trip }}
      {% if form.errors.trip %}
        <div class="text-red-600 text-xs mt-1">{{ form.errors.trip }}</div>
      {% endif %}
    </div>

    <!-- Seat map area -->
    <div id="seat-map-container" class="mt-4">
      <label class="block font-medium text-gray-700 mb-2">Select a seat</label>
      <div id="seat-map" class="grid grid-cols-8 gap-2 p-3 bg-gray-50 rounded border border-gray-200 min-h-[120px]">
        <!-- seats will be rendered here by JS -->
        <div id="seat-map-placeholder" class="col-span-8 text-sm text-gray-500 text-center py-8">
          Select a trip to load seat map.
        </div>
      </div>
      <input type="hidden" name="seat_number" id="id_seat_number" value="{{ form.seat_number.value|default_if_none:'' }}">
      <p id="seat-help" class="text-xs text-gray-500 mt-2">Click any available seat to choose it. You can also leave it blank to auto-assign.</p>
      <div id="seat-error" class="text-xs text-red-600 mt-2 hidden"></div>
    </div>

    <!-- show available seats summary -->
    <div id="seat-summary" class="text-sm text-gray-700 hidden">
      <strong>Available:</strong> <span id="available-count">0</span>
      <span class="mx-2">â€¢</span>
      <strong>Capacity:</strong> <span id="capacity-count">0</span>
    </div>

    <div class="pt-4">
      <button type="submit" class="w-full py-3 bg-transport-blue text-white rounded font-bold hover:bg-blue-700 transition">
        Confirm Booking
      </button>
    </div>
    <a href="{% url 'dashboard:trip-list' %}" class="block mt-2 text-center text-gray-600 hover:underline">Back to trips</a>
  </form>
</div>

<script>
(function () {
  // Utility: read query params (to support ?trip=ID pre-select)
  function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  const tripSelect = document.querySelector('#id_trip');
  const seatMap = document.getElementById('seat-map');
  const placeholder = document.getElementById('seat-map-placeholder');
  const availableCountEl = document.getElementById('available-count');
  const capacityCountEl = document.getElementById('capacity-count');
  const seatSummary = document.getElementById('seat-summary');
  const seatError = document.getElementById('seat-error');
  const seatInput = document.getElementById('id_seat_number');

  const API_URL = "{% url 'dashboard:trip-seat-map-json' %}";

  function setLoading() {
    seatMap.innerHTML = '<div class="col-span-8 text-sm text-gray-500 text-center py-8">Loading seat mapâ€¦</div>';
    seatSummary.classList.add('hidden');
    seatError.classList.add('hidden');
  }

  function renderSeatMap(data) {
    // data: { capacity: int, booked_seats: [ints], available: int, booked_by_current_user: int|null }
    seatMap.innerHTML = ''; // clear
    const capacity = data.capacity || 0;
    const booked = new Set(data.booked_seats || []);
    const cols = 8; // number of columns in seat grid
    const rows = Math.ceil(Math.max(capacity, 1) / cols);

    // If no seats at all
    if (capacity <= 0) {
      seatMap.innerHTML = '<div class="col-span-8 text-sm text-gray-500 text-center py-6">No seat map available for this vehicle.</div>';
      availableCountEl.textContent = data.available;
      capacityCountEl.textContent = capacity;
      seatSummary.classList.remove('hidden');
      return;
    }

    // Render seats row/col
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const index = r * cols + c + 1; // seat numbers start at 1
        if (index > capacity) {
          // render an empty placeholder to keep grid alignment
          const empty = document.createElement('div');
          empty.className = 'invisible';
          seatMap.appendChild(empty);
          continue;
        }

        const seat = document.createElement('button');
        seat.type = 'button';
        seat.dataset.seat = index;
        seat.className = 'text-xs py-2 px-2 rounded border focus:outline-none';
        seat.setAttribute('aria-label', 'Seat ' + index);

        if (booked.has(index)) {
          // seat is booked
          seat.classList.add('bg-red-100', 'text-red-700', 'border-red-200', 'cursor-not-allowed');
          seat.disabled = true;
          seat.innerHTML = '<span class="font-semibold">#' + index + '</span><div class="text-[10px] text-red-600">Booked</div>';
        } else {
          // available
          seat.classList.add('bg-green-50', 'text-green-800', 'border-green-200', 'hover:bg-green-100', 'cursor-pointer');
          seat.innerHTML = '<span class="font-semibold">#' + index + '</span><div class="text-[10px] text-green-700">Available</div>';
          seat.addEventListener('click', function (ev) {
            ev.preventDefault();
            clearSelection();
            seat.classList.remove('bg-green-50');
            seat.classList.add('bg-transport-blue', 'text-white');
            seatInput.value = index;
            seatError.classList.add('hidden');
          });
        }

        seatMap.appendChild(seat);
      }
    }

    // If a seat was pre-selected (e.g., editing or from POST), highlight it
    const preSelected = seatInput.value;
    if (preSelected) {
      const btn = seatMap.querySelector('[data-seat="' + preSelected + '"]');
      if (btn && !btn.disabled) {
        btn.classList.remove('bg-green-50');
        btn.classList.add('bg-transport-blue', 'text-white');
      } else {
        // pre-selected seat is not available
        seatError.textContent = 'Previously selected seat is no longer available â€” please choose another.';
        seatError.classList.remove('hidden');
        seatInput.value = '';
      }
    }

    availableCountEl.textContent = data.available;
    capacityCountEl.textContent = capacity;
    seatSummary.classList.remove('hidden');
  }

  function clearSelection() {
    seatMap.querySelectorAll('button[data-seat]').forEach(function (el) {
      if (!el.disabled) {
        el.classList.remove('bg-transport-blue', 'text-white');
        el.classList.add('bg-green-50', 'text-green-800');
      }
    });
    seatInput.value = '';
  }

  function fetchSeatMap(tripId) {
    if (!tripId) {
      seatMap.innerHTML = '<div id="seat-map-placeholder" class="col-span-8 text-sm text-gray-500 text-center py-8">Select a trip to load seat map.</div>';
      seatSummary.classList.add('hidden');
      return;
    }
    setLoading();
    fetch(API_URL + '?trip=' + encodeURIComponent(tripId), {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(function (res) {
      if (!res.ok) throw new Error('Failed to load seat map');
      return res.json();
    })
    .then(function (data) {
      renderSeatMap(data);
    })
    .catch(function (err) {
      seatMap.innerHTML = '<div class="col-span-8 text-sm text-red-600 text-center py-8">Unable to load seat map.</div>';
      seatSummary.classList.add('hidden');
      console.error(err);
    });
  }

  // Listen for trip selection change
  if (tripSelect) {
    tripSelect.addEventListener('change', function (e) {
      const tripId = e.target.value;
      // reset seat selection
      clearSelection();
      seatInput.value = '';
      fetchSeatMap(tripId);
    });

    // Pre-select via query param ?trip=ID
    const pre = getQueryParam('trip');
    if (pre) {
      // set selected option if present
      const opt = tripSelect.querySelector('option[value="' + pre + '"]');
      if (opt) {
        tripSelect.value = pre;
      }
    }

    // If form had an initial trip value (e.g., passed in view), load map for it
    const curTrip = tripSelect.value;
    if (curTrip) {
      fetchSeatMap(curTrip);
    }
  }

  // Form submit: client-side validation if seat was chosen ensure it's valid (server will re-validate)
  const formEl = document.getElementById('booking-form');
  if (formEl) {
    formEl.addEventListener('submit', function (e) {
      // if a seat is selected, ensure it's a positive integer
      const seatVal = seatInput.value;
      if (seatVal) {
        const n = parseInt(seatVal, 10);
        if (!n || n <= 0) {
          e.preventDefault();
          seatError.textContent = 'Selected seat is invalid.';
          seatError.classList.remove('hidden');
          return false;
        }
      }
      // allow submit; backend will attempt to reserve the seat in a transaction
    });
  }
})();
</script>
{% endblock %}