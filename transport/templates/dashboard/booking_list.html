{% extends "base.html" %}
{% block content %}
<div class="flex items-center gap-2 mb-6">
  <span class="text-3xl">ðŸŽ«</span>
  <h2 class="text-2xl font-bold text-transport-blue">My Bookings</h2>
</div>

<div class="bg-white rounded-xl shadow p-6">
  <div class="flex items-center justify-between mb-4">
    <a href="{% url 'dashboard:booking-add' %}" class="inline-block bg-transport-blue text-white px-4 py-2 rounded hover:bg-blue-700 transition font-semibold">
      âž• Book a Trip
    </a>

    <div class="text-sm text-gray-600">
      {# compute a total count in template-safe way to avoid complex expressions #}
      {% if bookings and bookings.paginator %}
        {% with total=bookings.paginator.count %}
          Showing {{ total }} booking{% if total != 1 %}s{% endif %}
        {% endwith %}
      {% else %}
        {% with total=bookings|length %}
          Showing {{ total }} booking{% if total != 1 %}s{% endif %}
        {% endwith %}
      {% endif %}
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Trip</th>
          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Departure</th>
          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Seat</th>
          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Booked At</th>
          <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Status</th>
          <th class="px-4 py-2"></th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-100">
        {% for booking in bookings %}
        <tr>
          <td class="px-4 py-3">
            <div class="font-medium text-gray-900">{{ booking.trip.route.name }}</div>
            <div class="text-xs text-gray-500">{{ booking.trip.route.code }}</div>
          </td>

          <td class="px-4 py-3 text-sm text-gray-700">
            {{ booking.trip.scheduled_departure|date:"Y-m-d H:i" }}
          </td>

          <td class="px-4 py-3 text-sm">
            {% if booking.seat_number %}
              <span class="inline-block bg-transport-blue text-white px-2 py-1 rounded text-xs font-semibold">#{{ booking.seat_number }}</span>
            {% else %}
              <span class="text-gray-500 text-xs">Auto-assign</span>
            {% endif %}
          </td>

          <td class="px-4 py-3 text-sm text-gray-700">
            {{ booking.booked_at|date:"Y-m-d H:i" }}
          </td>

          <td class="px-4 py-3 text-sm">
            {% if booking.status == 'confirmed' %}
              <span class="inline-block bg-green-600 text-white px-2 py-1 rounded text-xs">Confirmed</span>
            {% elif booking.status == 'pending' %}
              <span class="inline-block bg-transport-yellow text-black px-2 py-1 rounded text-xs">Pending</span>
            {% elif booking.status == 'cancelled' %}
              <span class="inline-block bg-red-600 text-white px-2 py-1 rounded text-xs">Cancelled</span>
            {% else %}
              <span class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">{{ booking.get_status_display }}</span>
            {% endif %}
          </td>

          <td class="px-4 py-3 text-sm whitespace-nowrap">
            <a href="{% url 'dashboard:booking-detail' booking.pk %}" class="text-blue-600 hover:underline mr-3">View</a>

            {% if request.user == booking.user %}
              {% if booking.status != 'cancelled' %}
                <a href="{% url 'dashboard:booking-edit' booking.pk %}" class="text-yellow-600 hover:underline mr-3">Edit</a>

                <form action="{% url 'dashboard:booking-edit' booking.pk %}" method="post" class="inline" onsubmit="return confirmCancelBooking(this);">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="cancelled">
                  <button type="submit" class="text-sm text-red-600 hover:underline">Cancel</button>
                </form>
              {% else %}
                <form action="{% url 'dashboard:booking-delete' booking.pk %}" method="post" class="inline" onsubmit="return confirmDeleteBooking(this);">
                  {% csrf_token %}
                  <button type="submit" class="text-sm text-gray-600 hover:underline">Delete</button>
                </form>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-4 py-6 text-center text-gray-500">No bookings found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
  <div class="mt-4 flex items-center justify-between">
    <div class="text-sm text-gray-600">
      Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </div>
    <div class="flex items-center space-x-2">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 border rounded text-sm hover:bg-gray-100">Previous</a>
      {% endif %}
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 border rounded text-sm hover:bg-gray-100">Next</a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

{% block extra_js %}
<script>
function confirmCancelBooking(form) {
  return confirm('Cancel this booking? This will release your seat and may be irreversible.');
}
function confirmDeleteBooking(form) {
  return confirm('Delete this booking permanently? This will remove the booking record and release the seat.');
}
</script>
{% endblock %}
{% endblock %}